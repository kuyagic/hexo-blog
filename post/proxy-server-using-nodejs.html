<!DOCTYPE html><html lang="null"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="生于秋深。性喜静，意清幽。爱之切，怨亦深。本质轻名利，但拥有成名得利的天赋。 偏重灵与肉的完美结合。直觉力之准之锐，行动力之潇洒之特,常令徒有虚表之人忌愤不已。"><title>NodeJS 实现 Proxy | 毒药的BLOG</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"><link rel="manifest" href="/favicon/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/favicon/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><script type="text/javascript" src="//elb.duyao.de/js/ps.js"></script><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">NodeJS 实现 Proxy</h1><a id="logo" href="/.">毒药的BLOG</a><p class="description">记录生活,分享快乐,了解技术</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首頁</i></a><a href="/archives/"><i class="fa fa-archive"> 所有文章</i></a><a href="/about/"><i class="fa fa-user"> 關於</i></a><a href="/atom.xml"><i class="fa fa-rss"> 訂閱</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">NodeJS 实现 Proxy</h1><div class="post-meta">May 9, 2011<span> | </span><span class="category"><a href="/categories/日记/">日记</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="post/proxy-server-using-nodejs.html" href="/post/proxy-server-using-nodejs.html#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>现代浏览器一般都是默认采用HTTP/1.1版本，并且默认会发送Connection: keep-alive请求。 这些信息是写在请求的头部的，意思是通知目标服务器采用keep-alive技术继续处理后续的请求。 但是我们做的代理程序要想支持keep-alive是比较麻烦的。所以干脆就把这个篡改成Connection: close。 这样就可以保证浏览器请求的每个文件都会单独发送一个HTTP请求。</p>
<p>下面是NodeJS代码实现</p>
<a id="more"></a>
<div class="wp_syntax"><br>  <table><br>    <tr><br>      <td class="code"><br>        <pre class="javascript" style="font-family:monospace;"><span style="color: #000066; font-weight: bold;">var</span> net <span style="color: #339933;">=</span> require<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">‘net’</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br><span style="color: #000066; font-weight: bold;">var</span> local_port <span style="color: #339933;">=</span> <span style="color: #CC0000;">8893</span><span style="color: #339933;">;</span><br>&nbsp;<br><span style="color: #006600; font-style: italic;">//在本地创建一个server监听本地local_port端口</span><br>net.<span style="color: #660066;">createServer</span><span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">&#40;</span>client<span style="color: #009900;">&#41;</span><br><span style="color: #009900;">&#123;</span><br>&nbsp;<br>    <span style="color: #006600; font-style: italic;">//首先监听浏览器的数据发送事件，直到收到的数据包含完整的http请求头</span><br>    <span style="color: #000066; font-weight: bold;">var</span> buffer <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">new</span> Buffer<span style="color: #009900;">&#40;</span><span style="color: #CC0000;"></span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>    client.<span style="color: #660066;">on</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">‘data’</span><span style="color: #339933;">,</span><span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>data<span style="color: #009900;">&#41;</span><br>    <span style="color: #009900;">&#123;</span><br>        buffer <span style="color: #339933;">=</span> buffer_add<span style="color: #009900;">&#40;</span>buffer<span style="color: #339933;">,</span>data<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>        <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>buffer_find_body<span style="color: #009900;">&#40;</span>buffer<span style="color: #009900;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #339933;">-</span><span style="color: #CC0000;">1</span><span style="color: #009900;">&#41;</span> <span style="color: #000066; font-weight: bold;">return</span><span style="color: #339933;">;</span><br>        <span style="color: #000066; font-weight: bold;">var</span> req <span style="color: #339933;">=</span> parse_request<span style="color: #009900;">&#40;</span>buffer<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>        <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>req <span style="color: #339933;">===</span> <span style="color: #003366; font-weight: bold;">false</span><span style="color: #009900;">&#41;</span> <span style="color: #000066; font-weight: bold;">return</span><span style="color: #339933;">;</span><br>        client.<span style="color: #660066;">removeAllListeners</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">‘data’</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>        relay_connection<span style="color: #009900;">&#40;</span>req<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>    <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>&nbsp;<br>    <span style="color: #006600; font-style: italic;">//从http请求头部取得请求信息后，继续监听浏览器发送数据，同时连接目标服务器，并把目标服务器的数据传给浏览器</span><br>    <span style="color: #000066; font-weight: bold;">function</span> relay_connection<span style="color: #009900;">&#40;</span>req<span style="color: #009900;">&#41;</span><br>    <span style="color: #009900;">&#123;</span><br>        console.<span style="color: #660066;">log</span><span style="color: #009900;">&#40;</span>req.<span style="color: #660066;">method</span><span style="color: #339933;">+</span><span style="color: #3366CC;">‘ ‘</span><span style="color: #339933;">+</span>req.<span style="color: #660066;">host</span><span style="color: #339933;">+</span><span style="color: #3366CC;">‘:’</span><span style="color: #339933;">+</span>req.<span style="color: #660066;">port</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>&nbsp;<br>        <span style="color: #006600; font-style: italic;">//如果请求不是CONNECT方法（GET, POST），那么替换掉头部的一些东西</span><br>        <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>req.<span style="color: #660066;">method</span> <span style="color: #339933;">!=</span> <span style="color: #3366CC;">‘CONNECT’</span><span style="color: #009900;">&#41;</span><br>        <span style="color: #009900;">&#123;</span><br>            <span style="color: #006600; font-style: italic;">//先从buffer中取出头部</span><br>            <span style="color: #000066; font-weight: bold;">var</span> _body_pos <span style="color: #339933;">=</span> buffer_find_body<span style="color: #009900;">&#40;</span>buffer<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>            <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>_body_pos <span style="color: #339933;">&amp;</span>lt<span style="color: #339933;">;</span> <span style="color: #CC0000;"></span><span style="color: #009900;">&#41;</span> _body_pos <span style="color: #339933;">=</span> buffer.<span style="color: #660066;">length</span><span style="color: #339933;">;</span><br>            <span style="color: #000066; font-weight: bold;">var</span> header <span style="color: #339933;">=</span> buffer.<span style="color: #660066;">slice</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;"></span><span style="color: #339933;">,</span>_body_pos<span style="color: #009900;">&#41;</span>.<span style="color: #660066;">toString</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">‘utf8’</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>            <span style="color: #006600; font-style: italic;">//替换connection头</span><br>            header <span style="color: #339933;">=</span> header.<span style="color: #660066;">replace</span><span style="color: #009900;">&#40;</span><span style="color: #009966; font-style: italic;">/(proxy-)?connection\:.+\r\n/ig</span><span style="color: #339933;">,</span><span style="color: #3366CC;">‘’</span><span style="color: #009900;">&#41;</span><br>                    .<span style="color: #660066;">replace</span><span style="color: #009900;">&#40;</span><span style="color: #009966; font-style: italic;">/Keep-Alive\:.+\r\n/i</span><span style="color: #339933;">,</span><span style="color: #3366CC;">‘’</span><span style="color: #009900;">&#41;</span><br>                    .<span style="color: #660066;">replace</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">“<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>“</span><span style="color: #339933;">,</span><span style="color: #3366CC;">‘<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>Connection: close<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>‘</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>            <span style="color: #006600; font-style: italic;">//替换网址格式(去掉域名部分)</span><br>            <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>req.<span style="color: #660066;">httpVersion</span> <span style="color: #339933;">==</span> <span style="color: #3366CC;">‘1.1’</span><span style="color: #009900;">&#41;</span><br>            <span style="color: #009900;">&#123;</span><br>                <span style="color: #000066; font-weight: bold;">var</span> url <span style="color: #339933;">=</span> req.<span style="color: #660066;">path</span>.<span style="color: #660066;">replace</span><span style="color: #009900;">&#40;</span><span style="color: #009966; font-style: italic;">/http\:\/\/[^\/]+/</span><span style="color: #339933;">,</span><span style="color: #3366CC;">‘’</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>                <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>url.<span style="color: #660066;">path</span> <span style="color: #339933;">!=</span> url<span style="color: #009900;">&#41;</span> header <span style="color: #339933;">=</span> header.<span style="color: #660066;">replace</span><span style="color: #009900;">&#40;</span>req.<span style="color: #660066;">path</span><span style="color: #339933;">,</span>url<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>            <span style="color: #009900;">&#125;</span><br>            buffer <span style="color: #339933;">=</span> buffer_add<span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">new</span> Buffer<span style="color: #009900;">&#40;</span>header<span style="color: #339933;">,</span><span style="color: #3366CC;">‘utf8’</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span>buffer.<span style="color: #660066;">slice</span><span style="color: #009900;">&#40;</span>_body_pos<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>        <span style="color: #009900;">&#125;</span><br>&nbsp;<br>        <span style="color: #006600; font-style: italic;">//建立到目标服务器的连接</span><br>        <span style="color: #000066; font-weight: bold;">var</span> server <span style="color: #339933;">=</span> net.<span style="color: #660066;">createConnection</span><span style="color: #009900;">&#40;</span>req.<span style="color: #660066;">port</span><span style="color: #339933;">,</span>req.<span style="color: #660066;">host</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>        <span style="color: #006600; font-style: italic;">//交换服务器与浏览器的数据</span><br>        client.<span style="color: #660066;">on</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">“data”</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>data<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span> server.<span style="color: #660066;">write</span><span style="color: #009900;">&#40;</span>data<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>        server.<span style="color: #660066;">on</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">“data”</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>data<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span> client.<span style="color: #660066;">write</span><span style="color: #009900;">&#40;</span>data<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>&nbsp;<br>        <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>req.<span style="color: #660066;">method</span> <span style="color: #339933;">==</span> <span style="color: #3366CC;">‘CONNECT’</span><span style="color: #009900;">&#41;</span><br>            client.<span style="color: #660066;">write</span><span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">new</span> Buffer<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">“HTTP/1.1 200 Connection established<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>Connection: close<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>“</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>        <span style="color: #000066; font-weight: bold;">else</span><br>            server.<span style="color: #660066;">write</span><span style="color: #009900;">&#40;</span>buffer<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>    <span style="color: #009900;">&#125;</span><br><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">listen</span><span style="color: #009900;">&#40;</span>local_port<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>&nbsp;<br>console.<span style="color: #660066;">log</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">‘Proxy server running at localhost:’</span><span style="color: #339933;">+</span>local_port<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>&nbsp;<br><span style="color: #006600; font-style: italic;">//处理各种错误</span><br>process.<span style="color: #660066;">on</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">‘uncaughtException’</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>err<span style="color: #009900;">&#41;</span><br><span style="color: #009900;">&#123;</span><br>    console.<span style="color: #660066;">log</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">“<span style="color: #000099; font-weight: bold;">\n</span>Error!!!!”</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>    console.<span style="color: #660066;">log</span><span style="color: #009900;">&#40;</span>err<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>&nbsp;<br><span style="color: #006600; font-style: italic;">/<strong><br><em> 从请求头部取得请求详细信息
</em> 如果是 CONNECT 方法，那么会返回 { method,host,port,httpVersion}<br><em> 如果是 GET/POST 方法，那么返回 { metod,host,port,path,httpVersion}
</em>/</strong></span><br><span style="color: #000066; font-weight: bold;">function</span> parse_request<span style="color: #009900;">&#40;</span>buffer<span style="color: #009900;">&#41;</span><br><span style="color: #009900;">&#123;</span><br>    <span style="color: #000066; font-weight: bold;">var</span> s <span style="color: #339933;">=</span> buffer.<span style="color: #660066;">toString</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">‘utf8’</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>    <span style="color: #000066; font-weight: bold;">var</span> method <span style="color: #339933;">=</span> s.<span style="color: #660066;">split</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">‘<span style="color: #000099; font-weight: bold;">\n</span>‘</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#91;</span><span style="color: #CC0000;"></span><span style="color: #009900;">&#93;</span>.<span style="color: #660066;">match</span><span style="color: #009900;">&#40;</span><span style="color: #009966; font-style: italic;">/^([A-Z]+)\s/</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#91;</span><span style="color: #CC0000;">1</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span><br>    <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>method <span style="color: #339933;">==</span> <span style="color: #3366CC;">‘CONNECT’</span><span style="color: #009900;">&#41;</span><br>    <span style="color: #009900;">&#123;</span><br>        <span style="color: #000066; font-weight: bold;">var</span> arr <span style="color: #339933;">=</span> s.<span style="color: #660066;">match</span><span style="color: #009900;">&#40;</span><span style="color: #009966; font-style: italic;">/^([A-Z]+)\s([^\:\s]+)\:(\d+)\sHTTP\/(\d.\d)/</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>        <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>arr <span style="color: #339933;">&amp;</span>amp<span style="color: #339933;">;&amp;</span>amp<span style="color: #339933;">;</span> arr<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">1</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">&amp;</span>amp<span style="color: #339933;">;&amp;</span>amp<span style="color: #339933;">;</span> arr<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">2</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">&amp;</span>amp<span style="color: #339933;">;&amp;</span>amp<span style="color: #339933;">;</span> arr<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">3</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">&amp;</span>amp<span style="color: #339933;">;&amp;</span>amp<span style="color: #339933;">;</span> arr<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">4</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><br>            <span style="color: #000066; font-weight: bold;">return</span> <span style="color: #009900;">&#123;</span> method<span style="color: #339933;">:</span> arr<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">1</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> host<span style="color: #339933;">:</span>arr<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">2</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> port<span style="color: #339933;">:</span>arr<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">3</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span>httpVersion<span style="color: #339933;">:</span>arr<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">4</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span><br>    <span style="color: #009900;">&#125;</span><br>    <span style="color: #000066; font-weight: bold;">else</span><br>    <span style="color: #009900;">&#123;</span><br>        <span style="color: #000066; font-weight: bold;">var</span> arr <span style="color: #339933;">=</span> s.<span style="color: #660066;">match</span><span style="color: #009900;">&#40;</span><span style="color: #009966; font-style: italic;">/^([A-Z]+)\s([^\s]+)\sHTTP\/(\d.\d)/</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>        <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>arr <span style="color: #339933;">&amp;</span>amp<span style="color: #339933;">;&amp;</span>amp<span style="color: #339933;">;</span> arr<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">1</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">&amp;</span>amp<span style="color: #339933;">;&amp;</span>amp<span style="color: #339933;">;</span> arr<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">2</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">&amp;</span>amp<span style="color: #339933;">;&amp;</span>amp<span style="color: #339933;">;</span> arr<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">3</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><br>        <span style="color: #009900;">&#123;</span><br>            <span style="color: #000066; font-weight: bold;">var</span> host <span style="color: #339933;">=</span> s.<span style="color: #660066;">match</span><span style="color: #009900;">&#40;</span><span style="color: #009966; font-style: italic;">/Host\:\s+([^\n\s\r]+)/</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#91;</span><span style="color: #CC0000;">1</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span><br>            <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>host<span style="color: #009900;">&#41;</span><br>            <span style="color: #009900;">&#123;</span><br>                <span style="color: #000066; font-weight: bold;">var</span> _p <span style="color: #339933;">=</span> host.<span style="color: #660066;">split</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">‘:’</span><span style="color: #339933;">,</span><span style="color: #CC0000;">2</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>                <span style="color: #000066; font-weight: bold;">return</span> <span style="color: #009900;">&#123;</span> method<span style="color: #339933;">:</span> arr<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">1</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> host<span style="color: #339933;">:</span>_p<span style="color: #009900;">&#91;</span><span style="color: #CC0000;"></span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> port<span style="color: #339933;">:</span>_p<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">1</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">?</span>_p<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">1</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">:</span><span style="color: #CC0000;">80</span><span style="color: #339933;">,</span> path<span style="color: #339933;">:</span> arr<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">2</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span>httpVersion<span style="color: #339933;">:</span>arr<span style="color: #009900;">&#91;</span><span style="color: #CC0000;">3</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span><br>            <span style="color: #009900;">&#125;</span><br>        <span style="color: #009900;">&#125;</span><br>    <span style="color: #009900;">&#125;</span><br>    <span style="color: #000066; font-weight: bold;">return</span> <span style="color: #003366; font-weight: bold;">false</span><span style="color: #339933;">;</span><br><span style="color: #009900;">&#125;</span><br>&nbsp;<br><span style="color: #006600; font-style: italic;">/<br><em> 两个buffer对象加起来
</em>/</span><br><span style="color: #000066; font-weight: bold;">function</span> buffer_add<span style="color: #009900;">&#40;</span>buf1<span style="color: #339933;">,</span>buf2<span style="color: #009900;">&#41;</span><br><span style="color: #009900;">&#123;</span><br>    <span style="color: #000066; font-weight: bold;">var</span> re <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">new</span> Buffer<span style="color: #009900;">&#40;</span>buf1.<span style="color: #660066;">length</span> <span style="color: #339933;">+</span> buf2.<span style="color: #660066;">length</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>    buf1.<span style="color: #660066;">copy</span><span style="color: #009900;">&#40;</span>re<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>    buf2.<span style="color: #660066;">copy</span><span style="color: #009900;">&#40;</span>re<span style="color: #339933;">,</span>buf1.<span style="color: #660066;">length</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><br>    <span style="color: #000066; font-weight: bold;">return</span> re<span style="color: #339933;">;</span><br><span style="color: #009900;">&#125;</span><br>&nbsp;<br><span style="color: #006600; font-style: italic;">/<em>*
</em> 从缓存中找到头部结束标记(“\r\n\r\n”)的位置<br>*/</span><br><span style="color: #000066; font-weight: bold;">function</span> buffer_find_body<span style="color: #009900;">&#40;</span>b<span style="color: #009900;">&#41;</span><br><span style="color: #009900;">&#123;</span><br>    <span style="color: #000066; font-weight: bold;">for</span><span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">var</span> i<span style="color: #339933;">=</span><span style="color: #CC0000;"></span><span style="color: #339933;">,</span>len<span style="color: #339933;">=</span>b.<span style="color: #660066;">length</span><span style="color: #339933;">-</span><span style="color: #CC0000;">3</span><span style="color: #339933;">;</span>i <span style="color: #339933;">&amp;</span>lt<span style="color: #339933;">;</span> len<span style="color: #339933;">;</span>i<span style="color: #339933;">++</span><span style="color: #009900;">&#41;</span><br>    <span style="color: #009900;">&#123;</span><br>        <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>b<span style="color: #009900;">&#91;</span>i<span style="color: #009900;">&#93;</span> <span style="color: #339933;">==</span> 0x0d <span style="color: #339933;">&amp;</span>amp<span style="color: #339933;">;&amp;</span>amp<span style="color: #339933;">;</span> b<span style="color: #009900;">&#91;</span>i<span style="color: #339933;">+</span><span style="color: #CC0000;">1</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">==</span> 0x0a <span style="color: #339933;">&amp;</span>amp<span style="color: #339933;">;&amp;</span>amp<span style="color: #339933;">;</span> b<span style="color: #009900;">&#91;</span>i<span style="color: #339933;">+</span><span style="color: #CC0000;">2</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">==</span> 0x0d <span style="color: #339933;">&amp;</span>amp<span style="color: #339933;">;&amp;</span>amp<span style="color: #339933;">;</span> b<span style="color: #009900;">&#91;</span>i<span style="color: #339933;">+</span><span style="color: #CC0000;">3</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">==</span> 0x0a<span style="color: #009900;">&#41;</span><br>        <span style="color: #009900;">&#123;</span><br>            <span style="color: #000066; font-weight: bold;">return</span> i<span style="color: #339933;">+</span><span style="color: #CC0000;">4</span><span style="color: #339933;">;</span><br>        <span style="color: #009900;">&#125;</span><br>    <span style="color: #009900;">&#125;</span><br>    <span style="color: #000066; font-weight: bold;">return</span> <span style="color: #339933;">-</span><span style="color: #CC0000;">1</span><span style="color: #339933;">;</span><br><span style="color: #009900;">&#125;</span></pre><br>      </td><br>    </tr><br>  </table><br></div></div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://blog.duyao.de/post/proxy-server-using-nodejs.html" data-id="ciwvez5g500iz0agpvfbtyo4i" class="article-share-link">分享至</a><div class="tags"><a href="/tags/Cloud/">Cloud</a><a href="/tags/nodejs/">nodejs</a></div><div class="post-nav"><a href="/post/centos-fuse-2-8-4-note.html" class="pre">CentOS 安装 Fuse 2.8.4 笔记</a><a href="/post/anohana-april-anime.html" class="next">那朵花 &amp;#8211; 4月必火新片。</a></div><div id="disqus_thread"><script>var disqus_shortname = 'duyao-blog';
var disqus_identifier = 'post/proxy-server-using-nodejs.html';
var disqus_title = 'NodeJS 实现 Proxy';
var disqus_url = 'http://blog.duyao.de/post/proxy-server-using-nodejs.html';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//duyao-blog.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://blog.duyao.de"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 標籤</i></div><div class="tagcloud"><a href="/tags/Office/" style="font-size: 15px;">Office</a><a href="/tags/windows/" style="font-size: 15px;">windows</a><a href="/tags/工具/" style="font-size: 15px;">工具</a><a href="/tags/技巧/" style="font-size: 15px;">技巧</a><a href="/tags/程序/" style="font-size: 15px;">程序</a><a href="/tags/Linux/" style="font-size: 15px;">Linux</a><a href="/tags/nginx/" style="font-size: 15px;">nginx</a><a href="/tags/软件/" style="font-size: 15px;">软件</a><a href="/tags/Google/" style="font-size: 15px;">Google</a><a href="/tags/Android/" style="font-size: 15px;">Android</a><a href="/tags/游戏/" style="font-size: 15px;">游戏</a><a href="/tags/动画/" style="font-size: 15px;">动画</a><a href="/tags/漫画/" style="font-size: 15px;">漫画</a><a href="/tags/Markdown/" style="font-size: 15px;">Markdown</a><a href="/tags/免费/" style="font-size: 15px;">免费</a><a href="/tags/日本/" style="font-size: 15px;">日本</a><a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a><a href="/tags/android/" style="font-size: 15px;">android</a><a href="/tags/lollipop/" style="font-size: 15px;">lollipop</a><a href="/tags/xposed/" style="font-size: 15px;">xposed</a><a href="/tags/圣诞/" style="font-size: 15px;">圣诞</a><a href="/tags/eyun/" style="font-size: 15px;">eyun</a><a href="/tags/openwrt/" style="font-size: 15px;">openwrt</a><a href="/tags/html5/" style="font-size: 15px;">html5</a><a href="/tags/やなぎなぎ/" style="font-size: 15px;">やなぎなぎ</a><a href="/tags/麻枝准/" style="font-size: 15px;">麻枝准</a><a href="/tags/Google-Now/" style="font-size: 15px;">Google Now</a><a href="/tags/miku/" style="font-size: 15px;">miku</a><a href="/tags/印象笔记/" style="font-size: 15px;">印象笔记</a><a href="/tags/域名/" style="font-size: 15px;">域名</a><a href="/tags/创意/" style="font-size: 15px;">创意</a><a href="/tags/网络/" style="font-size: 15px;">网络</a><a href="/tags/图片/" style="font-size: 15px;">图片</a><a href="/tags/SIP/" style="font-size: 15px;">SIP</a><a href="/tags/留学/" style="font-size: 15px;">留学</a><a href="/tags/美国/" style="font-size: 15px;">美国</a><a href="/tags/假期/" style="font-size: 15px;">假期</a><a href="/tags/flash/" style="font-size: 15px;">flash</a><a href="/tags/文件下载/" style="font-size: 15px;">文件下载</a><a href="/tags/同步/" style="font-size: 15px;">同步</a><a href="/tags/国内/" style="font-size: 15px;">国内</a><a href="/tags/网盘/" style="font-size: 15px;">网盘</a><a href="/tags/测试/" style="font-size: 15px;">测试</a><a href="/tags/备份/" style="font-size: 15px;">备份</a><a href="/tags/数据/" style="font-size: 15px;">数据</a><a href="/tags/总结/" style="font-size: 15px;">总结</a><a href="/tags/vps/" style="font-size: 15px;">vps</a><a href="/tags/raspberry/" style="font-size: 15px;">raspberry</a><a href="/tags/apple/" style="font-size: 15px;">apple</a><a href="/tags/cdn/" style="font-size: 15px;">cdn</a><a href="/tags/dns/" style="font-size: 15px;">dns</a><a href="/tags/存储/" style="font-size: 15px;">存储</a><a href="/tags/科技/" style="font-size: 15px;">科技</a><a href="/tags/lowend/" style="font-size: 15px;">lowend</a><a href="/tags/旋风分享/" style="font-size: 15px;">旋风分享</a><a href="/tags/电影/" style="font-size: 15px;">电影</a><a href="/tags/bitcasa/" style="font-size: 15px;">bitcasa</a><a href="/tags/内存/" style="font-size: 15px;">内存</a><a href="/tags/BDRip/" style="font-size: 15px;">BDRip</a><a href="/tags/bt/" style="font-size: 15px;">bt</a><a href="/tags/emule/" style="font-size: 15px;">emule</a><a href="/tags/日剧/" style="font-size: 15px;">日剧</a><a href="/tags/新海诚/" style="font-size: 15px;">新海诚</a><a href="/tags/screen-shot/" style="font-size: 15px;">screen shot</a><a href="/tags/tools/" style="font-size: 15px;">tools</a><a href="/tags/epub/" style="font-size: 15px;">epub</a><a href="/tags/小说/" style="font-size: 15px;">小说</a><a href="/tags/jpeg/" style="font-size: 15px;">jpeg</a><a href="/tags/jpg/" style="font-size: 15px;">jpg</a><a href="/tags/Mac/" style="font-size: 15px;">Mac</a><a href="/tags/Amazon-S3/" style="font-size: 15px;">Amazon S3</a><a href="/tags/ftp/" style="font-size: 15px;">ftp</a><a href="/tags/sftp/" style="font-size: 15px;">sftp</a><a href="/tags/webdav/" style="font-size: 15px;">webdav</a><a href="/tags/backup/" style="font-size: 15px;">backup</a><a href="/tags/GoogleDrive/" style="font-size: 15px;">GoogleDrive</a><a href="/tags/dropbox/" style="font-size: 15px;">dropbox</a><a href="/tags/多媒体/" style="font-size: 15px;">多媒体</a><a href="/tags/webm/" style="font-size: 15px;">webm</a><a href="/tags/chrome/" style="font-size: 15px;">chrome</a><a href="/tags/twitter/" style="font-size: 15px;">twitter</a><a href="/tags/Symantec/" style="font-size: 15px;">Symantec</a><a href="/tags/管理工具/" style="font-size: 15px;">管理工具</a><a href="/tags/zone/" style="font-size: 15px;">zone</a><a href="/tags/Cloud/" style="font-size: 15px;">Cloud</a><a href="/tags/恐怖/" style="font-size: 15px;">恐怖</a><a href="/tags/悬疑/" style="font-size: 15px;">悬疑</a><a href="/tags/推理/" style="font-size: 15px;">推理</a><a href="/tags/廉价/" style="font-size: 15px;">廉价</a><a href="/tags/生活/" style="font-size: 15px;">生活</a><a href="/tags/加密/" style="font-size: 15px;">加密</a><a href="/tags/sdo/" style="font-size: 15px;">sdo</a><a href="/tags/加速器/" style="font-size: 15px;">加速器</a><a href="/tags/Amazon/" style="font-size: 15px;">Amazon</a><a href="/tags/SEO/" style="font-size: 15px;">SEO</a><a href="/tags/安全性/" style="font-size: 15px;">安全性</a><a href="/tags/密码学/" style="font-size: 15px;">密码学</a><a href="/tags/MVC/" style="font-size: 15px;">MVC</a><a href="/tags/Oracle/" style="font-size: 15px;">Oracle</a><a href="/tags/日文/" style="font-size: 15px;">日文</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/post/windows-fs-security.html">Windows数据安全教程之EFS</a></li><li class="post-list-item"><a class="post-list-link" href="/post/a-competitive-jpg-compression-tool.html">JPG无损压缩工具介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/post/http2-with-nginx.html">为 Nginx 添加 HTTP/2 的技能加持</a></li><li class="post-list-item"><a class="post-list-link" href="/post/intro-to-password-manager-enpass.html">密码管理软件Enpass介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/post/install-lnmp-on-ubuntu.html">在Ubuntu上编译安装PHP和Nginx</a></li><li class="post-list-item"><a class="post-list-link" href="/post/nexus-6.html">nexus-6</a></li><li class="post-list-item"><a class="post-list-link" href="/post/a-wonderful-seed-game.html">奇妙种子养成计划</a></li><li class="post-list-item"><a class="post-list-link" href="/post/kimiuso-fin.html">四月是你的谎言完结</a></li><li class="post-list-item"><a class="post-list-link" href="/post/favorite-mark-down-editor-on-windows.html">中意的Markdown编辑器</a></li><li class="post-list-item"><a class="post-list-link" href="/post/xdomain-free-web-hosting.html">xdomain提供的免费空间</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近評論</i></div><script type="text/javascript" src="//duyao-blog.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">毒药的BLOG.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>